package swu

import (
	"encoding/hex"
	"fmt"
	"os"
	"time"
)

// WiresharkDebugger 输出 Wireshark 可用的解密信息
type WiresharkDebugger struct {
	file     *os.File
	enabled  bool
	filePath string
}

// NewWiresharkDebugger 创建 Wireshark 调试器
// 输出格式兼容 Wireshark 的 IKEv2 解密表
func NewWiresharkDebugger(enabled bool, filePath string) (*WiresharkDebugger, error) {
	if !enabled || filePath == "" {
		return &WiresharkDebugger{enabled: false}, nil
	}

	f, err := os.OpenFile(filePath, os.O_CREATE|os.O_WRONLY|os.O_APPEND, 0600)
	if err != nil {
		return nil, fmt.Errorf("打开调试文件失败: %v", err)
	}

	wd := &WiresharkDebugger{
		file:     f,
		enabled:  true,
		filePath: filePath,
	}

	// 写入头部注释
	wd.writeLine("# IKEv2/ESP Decryption Table")
	wd.writeLine("# Generated by swu-go at " + time.Now().Format(time.RFC3339))
	wd.writeLine("# Format: wireshark ikev2_decryption_table")
	wd.writeLine("")

	return wd, nil
}

// LogIKESAKeys 记录 IKE SA 密钥
// 格式: "IKEv2" <SPIi> <SPIr> <SK_ei> <SK_er> <SK_ai> <SK_ar> <encr_id> <integ_id>
func (wd *WiresharkDebugger) LogIKESAKeys(spiI, spiR uint64, skEi, skEr, skAi, skAr []byte, encrID, integID uint16) {
	if !wd.enabled {
		return
	}

	line := fmt.Sprintf("\"IKEv2\" \"%016x\" \"%016x\" \"%s\" \"%s\" \"%s\" \"%s\" \"%d\" \"%d\"",
		spiI, spiR,
		hex.EncodeToString(skEi),
		hex.EncodeToString(skEr),
		hex.EncodeToString(skAi),
		hex.EncodeToString(skAr),
		encrID, integID,
	)
	wd.writeLine(line)
}

// LogESPKeys 记录 ESP SA 密钥
// 格式: "ESP" <SPI> <src_ip> <dst_ip> <key> <encr_id>
func (wd *WiresharkDebugger) LogESPKeys(spi uint32, srcIP, dstIP string, key []byte, encrID uint16) {
	if !wd.enabled {
		return
	}

	// 适用于 Wireshark ESP 解密表
	// Edit -> Preferences -> Protocols -> ESP -> ESP SAs
	line := fmt.Sprintf("\"ESP\" \"0x%08x\" \"%s\" \"%s\" \"%s\" \"%d\"",
		spi, srcIP, dstIP,
		hex.EncodeToString(key),
		encrID,
	)
	wd.writeLine(line)
}

// LogChildSA 记录完整的 Child SA 信息
func (wd *WiresharkDebugger) LogChildSA(spiIn, spiOut uint32, localIP, remoteIP string, keyIn, keyOut []byte, encrID uint16) {
	if !wd.enabled {
		return
	}

	wd.writeLine(fmt.Sprintf("# Child SA established at %s", time.Now().Format(time.RFC3339)))
	wd.LogESPKeys(spiIn, remoteIP, localIP, keyIn, encrID)
	wd.LogESPKeys(spiOut, localIP, remoteIP, keyOut, encrID)
	wd.writeLine("")
}

// LogRaw 记录原始调试信息
func (wd *WiresharkDebugger) LogRaw(format string, args ...interface{}) {
	if !wd.enabled {
		return
	}
	wd.writeLine("# " + fmt.Sprintf(format, args...))
}

func (wd *WiresharkDebugger) writeLine(line string) {
	if wd.file != nil {
		wd.file.WriteString(line + "\n")
	}
}

// Close 关闭调试器
func (wd *WiresharkDebugger) Close() error {
	if wd.file != nil {
		return wd.file.Close()
	}
	return nil
}
